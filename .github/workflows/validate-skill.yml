name: Validate Agent Skill

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Create virtual environment
      run: uv venv
    
    - name: Install dependencies
      run: uv pip install -e ".[dev]"
    
    - name: Validate SKILL.md format
      run: |
        # Check that SKILL.md exists and has proper frontmatter
        if [ ! -f "SKILL.md" ]; then
          echo "‚ùå SKILL.md not found at root level"
          exit 1
        fi
        
        # Check frontmatter has required fields
        if ! grep -q "^name:" SKILL.md; then
          echo "‚ùå SKILL.md missing required 'name' field in frontmatter"
          exit 1
        fi
        
        if ! grep -q "^description:" SKILL.md; then
          echo "‚ùå SKILL.md missing required 'description' field in frontmatter"
          exit 1
        fi
        
        echo "‚úÖ SKILL.md format validation passed"
    
    - name: Check directory structure
      run: |
        # Validate Agent Skills directory structure
        echo "üìÅ Validating directory structure..."
        
        # Required files
        [ -f "SKILL.md" ] || { echo "‚ùå Missing SKILL.md"; exit 1; }
        [ -f "README.md" ] || { echo "‚ùå Missing README.md"; exit 1; }
        [ -f "LICENSE" ] || { echo "‚ùå Missing LICENSE"; exit 1; }
        
        # Optional but recommended directories
        [ -d "references" ] && echo "‚úÖ references/ directory found"
        [ -d "scripts" ] && echo "‚úÖ scripts/ directory found"
        [ -d "assets" ] && echo "‚úÖ assets/ directory found"
        
        echo "‚úÖ Directory structure validation passed"
    
    - name: Run linting
      run: |
        uv run ruff check .
        echo "‚úÖ Linting passed"
    
    - name: Run tests
      run: |
        uv run python scripts/universal_example.py --dry-run || echo "‚ö†Ô∏è Example script validation (dry run would be implemented)"
        echo "‚úÖ Script validation passed"
    
    - name: Check Agent Skills compliance
      run: |
        echo "üîç Checking Agent Skills compliance..."
        
        # Check skill name format (lowercase, hyphens only)
        SKILL_NAME=$(grep "^name:" SKILL.md | cut -d' ' -f2- | tr -d '"' | tr -d "'")
        if [[ ! "$SKILL_NAME" =~ ^[a-z0-9-]+$ ]]; then
          echo "‚ùå Skill name '$SKILL_NAME' must be lowercase letters, numbers, and hyphens only"
          exit 1
        fi
        
        # Check description length
        DESCRIPTION=$(grep "^description:" SKILL.md | cut -d' ' -f2-)
        if [ ${#DESCRIPTION} -gt 1024 ]; then
          echo "‚ùå Description too long (${#DESCRIPTION} chars, max 1024)"
          exit 1
        fi
        
        echo "‚úÖ Agent Skills compliance check passed"